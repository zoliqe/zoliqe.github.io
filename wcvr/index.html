<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<title>Webceiver</title>
<style>
html, body {
  overflow: hidden;
  margin: 0;
  padding: 0;
  background-color: #afafaf;
}
body > section {
  display: -webkit-flex;
  -webkit-flex-direction: column;
  /*-webkit-justify-content: center;*/
  /*-webkit-align-content: center;*/
  /*-webkit-align-items: center;*/
  box-sizing: border-box;
  height: 100%;
  /*-webkit-perspective: 800;*/
  /*-webkit-transform-style: preserve-3d;*/
}
section > * {
  display: -webkit-flex;
  /*-webkit-align-items: center;*/
}
select, button {
  padding: 10px;
  margin-top: 2px;
  margin-left: 5px;
}
label {
  margin-left: 10px;
}
#fft {
  border-color: gray;
  border-width: 2px;
  border-style: solid;
  top: 44px;
/*}*/
/*#controls {*/
  position: absolute;
  /*left: 0em;*/
  /*top: 0em;*/
  padding: 2px;
  width: 100%;
  height: 100%;
  background-color: #505050;
  color: #cfcfcf;
  /*z-index: 10;*/
}
#frequency {
  font-size: 80px;
  position: absolute;
  z-index: 1;
  right: 1em;
  opacity: 0.5;
  top: 0em;
  text-shadow: -2px -2px 0px rgba(255, 255, 255, 0.9), 2px 2px 0px rgba(0, 0, 0, 0.7);
  color: transparent;
  font-weight: 400;
}
</style>
</head>
<body>
<script src="tcvr.js"></script>
<script defer src="smartceiver-webusb.js"></script>

<div id="controls">
  <!--<label for="active">POWER</label>-->
  <button id="active">ON</button>
  <!--<label for="bandwidth">BW</label>-->
  <select id="bandwidth">
    <option value="300">300 Hz</option>
    <option value="600">600 Hz</option>
    <option value="1000">1 kHz</option>
    <option value="2400">2.4 kHz</option>
  </select>
  <!--<span id="bwValue"></span>-->
  <!--<label for="Q">Q</label>-->
  <!--<input id="Q" value="2" type="range" min="0.5" max="5" step="0.5"/>-->
  <!--<label for="band">BAND</label>-->
  <select id="band">
    <option value="0">80m</option>
    <option value="1">40m</option>
    <option value="2">30m</option>
    <option value="3">20m</option>
    <option value="4">17m</option>
    <option value="5">15m</option>
    <option value="6">12m</option>
    <option value="7">10m</option>
  </select>
  <label for="fast">FAST</label>
  <input type="checkbox" id="fast"></input>
  <label for="decwpm">WPM</label>
  <button id="decwpm">-</button>
  <label for="incwpm" id="wpm"></label>
  <button id="incwpm">+</button>
  <label for="send">SEND</label>
  <input id="send" type="text" size="20"></input>
  <button id="stop">X</button>
  <select id="sendmem">
    <option value="">MEM</option>
    <option value="CQ OM4AA OM4AA TEST">CQ TEST</option>
    <option value="CQ SOTA OM4AA/P OM4AA/P SOTA K">CQ SOTA</option>
    <option value="CQ SOTA OK/OM4AA/P OK/OM4AA/P SOTA K">CQ SOTA OK</option>
  </select>
  <!--<label for="repeat">RPT</label>-->
  <!--<input id="repeat" type="checkbox"></input>-->
  <!--<input id="repeat" type="number" size="3" value="0" min="0" max="300" step="1"></input>-->
  <select id="repeat">
    <option value="0">RPT</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
    <option value="10">10</option>
    <option value="12">12</option>
    <option value="14">14</option>
    <option value="16">16</option>
    <option value="18">18</option>
    <option value="20">20</option>
    <option value="30">30</option>
    <option value="40">40</option>
    <option value="50">50</option>
    <option value="60">60</option>
    <option value="90">90</option>
    <option value="120">120</option>
    <option value="180">180</option>
    <option value="240">240</option>
    <option value="300">300</option>
    <option value="600">600</option>
  </select>
</div>

<section>
  <div>
    <canvas id="fft" class="fft" width="1024" height="260"></canvas>
  </div>
  <h2 id="frequency"></h2>
</section>
<script>
let active = false
let audioCtx = null
let analyser = null
let audioStream = null
let bandwidth = 600
let fastTune = false
const tcvr = new Transceiver()
const filterArray = []
const filterCount = 10
const hpfCutoff = 300
const Q = 2
const cutoffDiv = 2

const canvas = document.querySelector('#fft')
const ctx = canvas.getContext('2d')
// canvas.width = document.body.clientWidth
// canvas.top = document.body.clientHeight - 50 - 260
const CANVAS_HEIGHT = canvas.height
const CANVAS_WIDTH = canvas.width

// controls
const activeBtn = document.querySelector('#active')
const bwSelect = document.querySelector('#bandwidth')
document.querySelector('#bandwidth [value="' + bandwidth + '"]').selected = true
// const bwValue = document.querySelector('#bwValue')
// bwValue.innerHTML = bwSlider.value
// const qSlider = document.getElementById('Q')
const bandSelect = document.querySelector('#band')
document.querySelector('#band [value="' + tcvr.band + '"]').selected = true
const fastSelect = document.querySelector('#fast')
const wpmDisplay = document.querySelector('#wpm')
wpmDisplay.textContent = tcvr.wpm
const wpmDecBtn = document.querySelector('#decwpm')
const wpmIncBtn = document.querySelector('#incwpm')
const freqDisplay = document.querySelector('#frequency')
freqChanged(tcvr.freq)

activeBtn.addEventListener('click', e => {
  active = !active
  activeBtn.textContent = active ? 'OFF' : 'ON'
  tcvr.switchPower()
  
  if (!active) {
    if (audioStream) {
      audioStream.getTracks().forEach(track => track.stop())
      audioStream = null
    }
    return
  }
  navigator.mediaDevices.getUserMedia({audio: true, video: false})
    .then(stream => {
      audioStream = stream
      audioCtx = new AudioContext()
      analyser = audioCtx.createAnalyser()
      analyser.fftSize = 2048
      canvas.width = analyser.frequencyBinCount / cutoffDiv //document.body.clientWidth //1.4;
      audioCtx.createMediaStreamSource(audioStream).connect(analyser)
      buildFilterChain()
      drawSpectrum()
    })
})

// bwSlider.addEventListener('input', e => {
//   bwValue.innerHTML = bwSlider.value
//   updateFilter()
// })
bwSelect.addEventListener('change', e => {
  bandwidth = parseInt(bwSelect.options[bwSelect.selectedIndex].value)
  updateFilter()
})

bandSelect.addEventListener('change', e => {
  tcvr.band = bandSelect.options[bandSelect.selectedIndex].value
})

fastSelect.addEventListener('change', e => {
  fastTune = fastSelect.checked
})

wpmDecBtn.addEventListener('click', e => {
  tcvr.wpm = tcvr.wpm - 2
  wpmDisplay.textContent = tcvr.wpm
})
wpmIncBtn.addEventListener('click', e => {
  tcvr.wpm = tcvr.wpm + 2
  wpmDisplay.textContent = tcvr.wpm
})

tcvr.addEventListener(EventType.freq, 'ui', event => freqChanged(event.value)) // listen for freq changes on mode/band change

let touchstart = 0
canvas.addEventListener('touchstart', e => {
  touchStart = e.changedTouches.item(0).pageX
})
canvas.addEventListener('touchmove', e => tuneByTouch(e))
canvas.addEventListener('touchend', e => tuneByTouch(e))

function tuneByTouch(event) {
  let position = event.changedTouches.item(0).pageX
  event.preventDefault()
  
  let delta = position - touchStart
  if (Math.abs(delta) > 5) {
    if (delta > 0) {
      tcvr.freq = tcvr.freq + (fastTune ? 200 : 20)
    } else {
      tcvr.freq = tcvr.freq - (fastTune ? 200 : 20)
    }
    touchStart = position
  }
}

function freqChanged(freq) {
  freqDisplay.textContent = formatFreq(freq)
}

function formatFreq(freq) {
  this._freq = freq; // store value for change detect
  let mhz = Math.floor(freq / 1000000);
  let res = '' + mhz + '.';
  let khz = (freq - mhz * 1000000) / 1000;
  if (khz < 10) {
   res += '0';
  }
  if (khz < 100) {
   res += '0';
  }
 res += khz;
  if (khz % 1 === 0) {
   res += '.00';
  } else if (freq % 100 === 0) {
   res += '0';
  }
  return res;
}

function buildFilterChain() {
  console.log("building " + filterCount + " filters...")
  const hpf = audioCtx.createBiquadFilter()
  hpf.type = 'highpass'
  hpf.frequency.setValueAtTime(hpfCutoff, 0)

  for (let i = 0; i < filterCount; i++) {
    const filter = audioCtx.createBiquadFilter()
    filterArray[i] = filter
    filter.type = 'lowpass'
    if (i > 0) {
      filterArray[i - 1].connect(filter)
    }
  }
  updateFilter()

  analyser.connect(hpf)
  hpf.connect(filterArray[0])
  filterArray[filterCount - 1].connect(audioCtx.destination)
  console.log("filters build done")
}

function updateFilter() {
  const lpfCutoff = bandwidth + hpfCutoff // add hpf cutoff to bandwidth
  console.log("bandwidth=" + bandwidth + ", lpfCutoff=" + lpfCutoff)
  for (let i = 0; i < filterCount; i++) {
    const filter = filterArray[i]
    filter.frequency.setValueAtTime(lpfCutoff, 0)
    filter.Q.setValueAtTime(Q/*centerFreq / bandwidth*/, 0)
  }
}

function drawSpectrum(time) {
  window.requestAnimationFrame(drawSpectrum, canvas)

  let freqByteData = new Uint8Array(analyser.frequencyBinCount)
  analyser.getByteFrequencyData(freqByteData) //analyser.getByteTimeDomainData(freqByteData);
  const binFreq = binFrequency(1)
  // var numBars = Math.round(CANVAS_WIDTH / SPACER_WIDTH);

  ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT)
  ctx.globalAlpha = 1.0
  for (let i = 0; i < analyser.frequencyBinCount / cutoffDiv; ++i) {
    if (i > 20 && (i * binFreq) % 1000 < 20) {
      ctx.fillStyle = '#404040'
      ctx.fillRect(i, CANVAS_HEIGHT, 1, -CANVAS_HEIGHT)
    }
    const magnitude = freqByteData[i]
    ctx.fillStyle = 'rgb(50,' + magnitude + ',50)'
    ctx.fillRect(i, CANVAS_HEIGHT, 1, -magnitude)
  }

  ctx.globalAlpha = 0.5
  ctx.fillStyle = '#615913'
  ctx.lineCap = 'round'
  ctx.fillRect(hpfCutoff / binFreq, CANVAS_HEIGHT, bandwidth / binFreq, -CANVAS_HEIGHT)
}

function binFrequency(n) {
  return n * audioCtx.sampleRate / analyser.fftSize
}
</script>
</body>
</html>
